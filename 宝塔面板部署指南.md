# ğŸš€ å®å¡”é¢æ¿ Docker éƒ¨ç½²æŒ‡å—

> ä½¿ç”¨å®å¡”é¢æ¿çš„ Docker åŠŸèƒ½ï¼Œæ— éœ€é˜¿é‡Œäº‘ ACRï¼Œç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šæ„å»ºå’Œéƒ¨ç½²åº”ç”¨

## ğŸ¯ éƒ¨ç½²æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å¤æ‚åº¦ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|------|--------|------|----------|
| **å®å¡”é¢æ¿ + Docker** | â­â­ | å…è´¹ | ä¸ªäººé¡¹ç›®ã€å°å›¢é˜Ÿ |
| GitHub Actions + ACR | â­â­â­â­ | ä»˜è´¹ | ä¼ä¸šé¡¹ç›®ã€å¤§å›¢é˜Ÿ |

## ğŸ“‹ éƒ¨ç½²æµç¨‹

### æ–¹æ¡ˆä¸€ï¼šå®å¡”é¢æ¿å¯è§†åŒ–éƒ¨ç½² (æ¨èæ–°æ‰‹)

#### ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡é¡¹ç›®æ–‡ä»¶

1. **ä¸Šä¼ é¡¹ç›®åˆ°æœåŠ¡å™¨**
   ```bash
   # æ–¹æ³•1ï¼šé€šè¿‡å®å¡”æ–‡ä»¶ç®¡ç†å™¨ä¸Šä¼ 
   # åœ¨å®å¡”é¢æ¿ â†’ æ–‡ä»¶ â†’ ä¸Šä¼ é¡¹ç›®å‹ç¼©åŒ…åˆ° /www/wwwroot/cosmos-explorer
   
   # æ–¹æ³•2ï¼šé€šè¿‡ Git å…‹éš†
   cd /www/wwwroot
   git clone https://github.com/ä½ çš„ç”¨æˆ·å/cosmos-explorer.git
   ```

2. **ç¡®ä¿é¡¹ç›®åŒ…å«å¿…è¦æ–‡ä»¶**
   ```
   cosmos-explorer/
   â”œâ”€â”€ Dockerfile              # Docker æ„å»ºæ–‡ä»¶
   â”œâ”€â”€ nginx.conf              # Nginx é…ç½®
   â”œâ”€â”€ package.json            # é¡¹ç›®ä¾èµ–
   â””â”€â”€ src/                    # æºä»£ç 
   ```

#### ç¬¬äºŒæ­¥ï¼šé€šè¿‡å®å¡”é¢æ¿åˆ›å»ºå®¹å™¨

1. **è¿›å…¥ Docker ç®¡ç†**
   - ç™»å½•å®å¡”é¢æ¿
   - ç‚¹å‡»å·¦ä¾§èœå• "Docker"
   - å¦‚æœæ²¡æœ‰å®‰è£…ï¼Œç‚¹å‡»"å®‰è£… Docker"

2. **æ„å»ºé•œåƒ**
   - ç‚¹å‡»"é•œåƒç®¡ç†"
   - ç‚¹å‡»"æ„å»ºé•œåƒ"
   - å¡«å†™ä¿¡æ¯ï¼š
     ```
     é•œåƒåç§°: cosmos-explorer
     æ ‡ç­¾: latest
     Dockerfileè·¯å¾„: /www/wwwroot/cosmos-explorer/Dockerfile
     æ„å»ºä¸Šä¸‹æ–‡: /www/wwwroot/cosmos-explorer
     ```
   - ç‚¹å‡»"å¼€å§‹æ„å»º"

3. **åˆ›å»ºå®¹å™¨**
   - æ„å»ºå®Œæˆåï¼Œç‚¹å‡»"å®¹å™¨ç®¡ç†"
   - ç‚¹å‡»"åˆ›å»ºå®¹å™¨"
   - é€‰æ‹©åˆšæ„å»ºçš„é•œåƒ `cosmos-explorer:latest`
   - é…ç½®å®¹å™¨ï¼š
     ```
     å®¹å™¨åç§°: cosmos-explorer-app
     ç«¯å£æ˜ å°„: 80:80 (å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£)
     é‡å¯ç­–ç•¥: always
     ```
   - ç‚¹å‡»"åˆ›å»ºå¹¶å¯åŠ¨"

#### ç¬¬ä¸‰æ­¥ï¼šéªŒè¯éƒ¨ç½²

1. **æ£€æŸ¥å®¹å™¨çŠ¶æ€**
   - åœ¨"å®¹å™¨ç®¡ç†"ä¸­æŸ¥çœ‹å®¹å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
   - çŠ¶æ€åº”è¯¥æ˜¾ç¤ºä¸º"è¿è¡Œä¸­"

2. **è®¿é—®åº”ç”¨**
   - æµè§ˆå™¨è®¿é—®ï¼š`http://ä½ çš„æœåŠ¡å™¨IP`
   - åº”è¯¥èƒ½çœ‹åˆ°å®‡å®™æ¢ç´¢è€…åº”ç”¨

### æ–¹æ¡ˆäºŒï¼šå‘½ä»¤è¡Œ + å®å¡”é¢æ¿æ··åˆéƒ¨ç½²

#### ç¬¬ä¸€æ­¥ï¼šSSH è¿æ¥æœåŠ¡å™¨

```bash
# è¿æ¥åˆ°ä½ çš„é˜¿é‡Œäº‘æœåŠ¡å™¨
ssh root@ä½ çš„æœåŠ¡å™¨IP
```

#### ç¬¬äºŒæ­¥ï¼šå‡†å¤‡é¡¹ç›®

```bash
# è¿›å…¥ç½‘ç«™ç›®å½•
cd /www/wwwroot

# å…‹éš†é¡¹ç›®ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
git clone https://github.com/ä½ çš„ç”¨æˆ·å/cosmos-explorer.git
cd cosmos-explorer

# æ„å»º Docker é•œåƒ
docker build -t cosmos-explorer:latest .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name cosmos-explorer-app \
  -p 80:80 \
  --restart unless-stopped \
  cosmos-explorer:latest
```

#### ç¬¬ä¸‰æ­¥ï¼šåœ¨å®å¡”é¢æ¿ä¸­ç®¡ç†

1. **æŸ¥çœ‹å®¹å™¨**
   - è¿›å…¥å®å¡”é¢æ¿ â†’ Docker â†’ å®¹å™¨ç®¡ç†
   - å¯ä»¥çœ‹åˆ°åˆšåˆ›å»ºçš„ `cosmos-explorer-app` å®¹å™¨

2. **ç®¡ç†å®¹å™¨**
   - å¯åŠ¨/åœæ­¢/é‡å¯å®¹å™¨
   - æŸ¥çœ‹å®¹å™¨æ—¥å¿—
   - è¿›å…¥å®¹å™¨ç»ˆç«¯
   - ç›‘æ§èµ„æºä½¿ç”¨

## ğŸ”„ æ›´æ–°éƒ¨ç½²æµç¨‹

### æ–¹æ³•ä¸€ï¼šé€šè¿‡å®å¡”é¢æ¿æ›´æ–°

1. **æ›´æ–°ä»£ç **
   ```bash
   # SSH è¿æ¥æœåŠ¡å™¨
   cd /www/wwwroot/cosmos-explorer
   git pull origin main
   ```

2. **é‡æ–°æ„å»ºé•œåƒ**
   - å®å¡”é¢æ¿ â†’ Docker â†’ é•œåƒç®¡ç†
   - æ‰¾åˆ° `cosmos-explorer:latest`
   - ç‚¹å‡»"é‡æ–°æ„å»º"

3. **é‡å¯å®¹å™¨**
   - å®¹å™¨ç®¡ç† â†’ æ‰¾åˆ° `cosmos-explorer-app`
   - ç‚¹å‡»"é‡å¯"

### æ–¹æ³•äºŒï¼šå‘½ä»¤è¡Œå¿«é€Ÿæ›´æ–°

```bash
# åˆ›å»ºæ›´æ–°è„šæœ¬
cat > /www/wwwroot/cosmos-explorer/update.sh << 'EOF'
#!/bin/bash
echo "ğŸ”„ å¼€å§‹æ›´æ–°åº”ç”¨..."

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /www/wwwroot/cosmos-explorer

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# åœæ­¢æ—§å®¹å™¨
docker stop cosmos-explorer-app
docker rm cosmos-explorer-app

# é‡æ–°æ„å»ºé•œåƒ
docker build -t cosmos-explorer:latest .

# å¯åŠ¨æ–°å®¹å™¨
docker run -d \
  --name cosmos-explorer-app \
  -p 80:80 \
  --restart unless-stopped \
  cosmos-explorer:latest

echo "âœ… æ›´æ–°å®Œæˆï¼"
EOF

# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x update.sh

# æ‰§è¡Œæ›´æ–°
./update.sh
```

## ğŸ“Š å®å¡”é¢æ¿ Docker åŠŸèƒ½ä»‹ç»

### é•œåƒç®¡ç†
- **æŸ¥çœ‹é•œåƒ**ï¼šåˆ—å‡ºæ‰€æœ‰ Docker é•œåƒ
- **æ„å»ºé•œåƒ**ï¼šä» Dockerfile æ„å»ºæ–°é•œåƒ
- **åˆ é™¤é•œåƒ**ï¼šæ¸…ç†ä¸éœ€è¦çš„é•œåƒ
- **æ‹‰å–é•œåƒ**ï¼šä» Docker Hub æ‹‰å–å…¬å…±é•œåƒ

### å®¹å™¨ç®¡ç†
- **åˆ›å»ºå®¹å™¨**ï¼šä»é•œåƒåˆ›å»ºæ–°å®¹å™¨
- **å¯åŠ¨/åœæ­¢**ï¼šæ§åˆ¶å®¹å™¨è¿è¡ŒçŠ¶æ€
- **æŸ¥çœ‹æ—¥å¿—**ï¼šå®æ—¶æŸ¥çœ‹å®¹å™¨æ—¥å¿—
- **è¿›å…¥ç»ˆç«¯**ï¼šç›´æ¥è¿›å…¥å®¹å™¨å†…éƒ¨
- **èµ„æºç›‘æ§**ï¼šæŸ¥çœ‹ CPUã€å†…å­˜ä½¿ç”¨æƒ…å†µ

### ç½‘ç»œç®¡ç†
- **ç«¯å£æ˜ å°„**ï¼šé…ç½®å®¹å™¨ç«¯å£æ˜ å°„
- **ç½‘ç»œæ¨¡å¼**ï¼šé€‰æ‹©å®¹å™¨ç½‘ç»œæ¨¡å¼
- **è‡ªå®šä¹‰ç½‘ç»œ**ï¼šåˆ›å»º Docker ç½‘ç»œ

## ğŸ”§ å¸¸ç”¨æ“ä½œ

### æŸ¥çœ‹åº”ç”¨çŠ¶æ€

1. **é€šè¿‡å®å¡”é¢æ¿**
   - Docker â†’ å®¹å™¨ç®¡ç†
   - æŸ¥çœ‹ `cosmos-explorer-app` çŠ¶æ€

2. **é€šè¿‡å‘½ä»¤è¡Œ**
   ```bash
   # æŸ¥çœ‹å®¹å™¨çŠ¶æ€
   docker ps | grep cosmos-explorer
   
   # æŸ¥çœ‹å®¹å™¨æ—¥å¿—
   docker logs cosmos-explorer-app -f
   
   # æŸ¥çœ‹èµ„æºä½¿ç”¨
   docker stats cosmos-explorer-app
   ```

### æ•…éšœæ’é™¤

1. **å®¹å™¨æ— æ³•å¯åŠ¨**
   ```bash
   # æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
   docker logs cosmos-explorer-app
   
   # æ£€æŸ¥ç«¯å£å ç”¨
   netstat -tlnp | grep :80
   
   # é‡æ–°æ„å»ºé•œåƒ
   docker build -t cosmos-explorer:latest .
   ```

2. **åº”ç”¨æ— æ³•è®¿é—®**
   ```bash
   # æ£€æŸ¥é˜²ç«å¢™
   # åœ¨å®å¡”é¢æ¿ â†’ å®‰å…¨ â†’ é˜²ç«å¢™
   # ç¡®ä¿ 80 ç«¯å£å·²å¼€æ”¾
   
   # æ£€æŸ¥å®¹å™¨ç«¯å£æ˜ å°„
   docker port cosmos-explorer-app
   ```

### å¤‡ä»½å’Œæ¢å¤

1. **å¤‡ä»½é•œåƒ**
   ```bash
   # å¯¼å‡ºé•œåƒ
   docker save cosmos-explorer:latest > cosmos-explorer-backup.tar
   
   # å‹ç¼©å¤‡ä»½
   gzip cosmos-explorer-backup.tar
   ```

2. **æ¢å¤é•œåƒ**
   ```bash
   # å¯¼å…¥é•œåƒ
   docker load < cosmos-explorer-backup.tar.gz
   ```

## ğŸš€ è‡ªåŠ¨åŒ–è„šæœ¬

### ä¸€é”®éƒ¨ç½²è„šæœ¬

```bash
# åˆ›å»ºä¸€é”®éƒ¨ç½²è„šæœ¬
cat > /www/wwwroot/deploy-cosmos.sh << 'EOF'
#!/bin/bash

PROJECT_DIR="/www/wwwroot/cosmos-explorer"
CONTAINER_NAME="cosmos-explorer-app"
IMAGE_NAME="cosmos-explorer:latest"

echo "ğŸš€ å¼€å§‹éƒ¨ç½²å®‡å®™æ¢ç´¢è€…..."

# æ£€æŸ¥é¡¹ç›®ç›®å½•
if [ ! -d "$PROJECT_DIR" ]; then
    echo "ğŸ“¥ å…‹éš†é¡¹ç›®..."
    cd /www/wwwroot
    git clone https://github.com/ä½ çš„ç”¨æˆ·å/cosmos-explorer.git
fi

# è¿›å…¥é¡¹ç›®ç›®å½•
cd $PROJECT_DIR

# æ‹‰å–æœ€æ–°ä»£ç 
echo "ğŸ“¡ æ‹‰å–æœ€æ–°ä»£ç ..."
git pull origin main

# åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
echo "ğŸ›‘ åœæ­¢æ—§å®¹å™¨..."
docker stop $CONTAINER_NAME 2>/dev/null || true
docker rm $CONTAINER_NAME 2>/dev/null || true

# æ„å»ºæ–°é•œåƒ
echo "ğŸ”¨ æ„å»º Docker é•œåƒ..."
docker build -t $IMAGE_NAME .

# å¯åŠ¨æ–°å®¹å™¨
echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨..."
docker run -d \
  --name $CONTAINER_NAME \
  -p 80:80 \
  --restart unless-stopped \
  $IMAGE_NAME

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
sleep 5
if docker ps | grep -q $CONTAINER_NAME; then
    echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
    echo "ğŸŒ è®¿é—®åœ°å€: http://$(curl -s ifconfig.me)"
else
    echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼š"
    docker logs $CONTAINER_NAME
fi
EOF

chmod +x /www/wwwroot/deploy-cosmos.sh
```

### å®šæ—¶æ›´æ–°è„šæœ¬

```bash
# æ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡
# å®å¡”é¢æ¿ â†’ è®¡åˆ’ä»»åŠ¡ â†’ æ·»åŠ ä»»åŠ¡
# ä»»åŠ¡ç±»å‹ï¼šShellè„šæœ¬
# æ‰§è¡Œå‘¨æœŸï¼šæ¯å¤©å‡Œæ™¨2ç‚¹
# è„šæœ¬å†…å®¹ï¼š
/www/wwwroot/deploy-cosmos.sh > /tmp/cosmos-deploy.log 2>&1
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ç›®å½•ç»“æ„å»ºè®®

```
/www/wwwroot/
â”œâ”€â”€ cosmos-explorer/          # é¡¹ç›®ç›®å½•
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ nginx.conf
â”‚   â””â”€â”€ src/
â”œâ”€â”€ deploy-cosmos.sh          # éƒ¨ç½²è„šæœ¬
â””â”€â”€ backups/                  # å¤‡ä»½ç›®å½•
    â””â”€â”€ cosmos-explorer-*.tar.gz
```

### 2. å®‰å…¨é…ç½®

1. **é˜²ç«å¢™è®¾ç½®**
   - å®å¡”é¢æ¿ â†’ å®‰å…¨ â†’ é˜²ç«å¢™
   - åªå¼€æ”¾å¿…è¦ç«¯å£ï¼š22 (SSH), 80 (HTTP), 443 (HTTPS), 8888 (å®å¡”)

2. **SSL è¯ä¹¦**
   - å®å¡”é¢æ¿ â†’ ç½‘ç«™ â†’ SSL
   - ç”³è¯·å…è´¹ Let's Encrypt è¯ä¹¦

### 3. ç›‘æ§å‘Šè­¦

1. **å®å¡”ç›‘æ§**
   - å®å¡”é¢æ¿ â†’ ç›‘æ§
   - è®¾ç½® CPUã€å†…å­˜ã€ç£ç›˜å‘Šè­¦

2. **å®¹å™¨ç›‘æ§**
   ```bash
   # åˆ›å»ºç›‘æ§è„šæœ¬
   cat > /www/wwwroot/monitor-cosmos.sh << 'EOF'
   #!/bin/bash
   
   if ! docker ps | grep -q cosmos-explorer-app; then
       echo "å®¹å™¨å¼‚å¸¸ï¼Œå°è¯•é‡å¯..."
       /www/wwwroot/deploy-cosmos.sh
   fi
   EOF
   
   # æ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡ï¼ˆæ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰
   ```

## ğŸ“ æ€»ç»“

ä½¿ç”¨å®å¡”é¢æ¿ + Docker çš„éƒ¨ç½²æ–¹æ¡ˆå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. **ç®€å•æ˜“ç”¨**ï¼šå›¾å½¢ç•Œé¢æ“ä½œï¼Œé™ä½æŠ€æœ¯é—¨æ§›
2. **æˆæœ¬ä½å»‰**ï¼šæ— éœ€é¢å¤–çš„é•œåƒä»“åº“è´¹ç”¨
3. **åŠŸèƒ½å®Œæ•´**ï¼šæ”¯æŒå®¹å™¨çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸç®¡ç†
4. **é›†æˆåº¦é«˜**ï¼šä¸å®å¡”é¢æ¿å…¶ä»–åŠŸèƒ½æ— ç¼é›†æˆ

è¿™ä¸ªæ–¹æ¡ˆç‰¹åˆ«é€‚åˆï¼š
- ä¸ªäººå¼€å‘è€…
- å°å‹å›¢é˜Ÿ
- å¯¹æˆæœ¬æ•æ„Ÿçš„é¡¹ç›®
- ä¸ç†Ÿæ‚‰å¤æ‚ CI/CD æµç¨‹çš„ç”¨æˆ·

ä½ è§‰å¾—è¿™ä¸ªåŸºäºå®å¡”é¢æ¿çš„éƒ¨ç½²æ–¹æ¡ˆå¦‚ä½•ï¼Ÿéœ€è¦æˆ‘è¯¦ç»†è¯´æ˜æŸä¸ªæ­¥éª¤å—ï¼Ÿ
