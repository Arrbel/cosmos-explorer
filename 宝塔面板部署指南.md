# 🚀 宝塔面板 Docker 部署指南

> 使用宝塔面板的 Docker 功能，无需阿里云 ACR，直接在服务器上构建和部署应用

## 🎯 部署方案对比

| 方案 | 复杂度 | 成本 | 适用场景 |
|------|--------|------|----------|
| **宝塔面板 + Docker** | ⭐⭐ | 免费 | 个人项目、小团队 |
| GitHub Actions + ACR | ⭐⭐⭐⭐ | 付费 | 企业项目、大团队 |

## 📋 部署流程

### 方案一：宝塔面板可视化部署 (推荐新手)

#### 第一步：准备项目文件

1. **上传项目到服务器**
   ```bash
   # 方法1：通过宝塔文件管理器上传
   # 在宝塔面板 → 文件 → 上传项目压缩包到 /www/wwwroot/cosmos-explorer
   
   # 方法2：通过 Git 克隆
   cd /www/wwwroot
   git clone https://github.com/你的用户名/cosmos-explorer.git
   ```

2. **确保项目包含必要文件**
   ```
   cosmos-explorer/
   ├── Dockerfile              # Docker 构建文件
   ├── nginx.conf              # Nginx 配置
   ├── package.json            # 项目依赖
   └── src/                    # 源代码
   ```

#### 第二步：通过宝塔面板创建容器

1. **进入 Docker 管理**
   - 登录宝塔面板
   - 点击左侧菜单 "Docker"
   - 如果没有安装，点击"安装 Docker"

2. **构建镜像**
   - 点击"镜像管理"
   - 点击"构建镜像"
   - 填写信息：
     ```
     镜像名称: cosmos-explorer
     标签: latest
     Dockerfile路径: /www/wwwroot/cosmos-explorer/Dockerfile
     构建上下文: /www/wwwroot/cosmos-explorer
     ```
   - 点击"开始构建"

3. **创建容器**
   - 构建完成后，点击"容器管理"
   - 点击"创建容器"
   - 选择刚构建的镜像 `cosmos-explorer:latest`
   - 配置容器：
     ```
     容器名称: cosmos-explorer-app
     端口映射: 80:80 (宿主机端口:容器端口)
     重启策略: always
     ```
   - 点击"创建并启动"

#### 第三步：验证部署

1. **检查容器状态**
   - 在"容器管理"中查看容器是否正常运行
   - 状态应该显示为"运行中"

2. **访问应用**
   - 浏览器访问：`http://你的服务器IP`
   - 应该能看到宇宙探索者应用

### 方案二：命令行 + 宝塔面板混合部署

#### 第一步：SSH 连接服务器

```bash
# 连接到你的阿里云服务器
ssh root@你的服务器IP
```

#### 第二步：准备项目

```bash
# 进入网站目录
cd /www/wwwroot

# 克隆项目（如果还没有）
git clone https://github.com/你的用户名/cosmos-explorer.git
cd cosmos-explorer

# 构建 Docker 镜像
docker build -t cosmos-explorer:latest .

# 运行容器
docker run -d \
  --name cosmos-explorer-app \
  -p 80:80 \
  --restart unless-stopped \
  cosmos-explorer:latest
```

#### 第三步：在宝塔面板中管理

1. **查看容器**
   - 进入宝塔面板 → Docker → 容器管理
   - 可以看到刚创建的 `cosmos-explorer-app` 容器

2. **管理容器**
   - 启动/停止/重启容器
   - 查看容器日志
   - 进入容器终端
   - 监控资源使用

## 🔄 更新部署流程

### 方法一：通过宝塔面板更新

1. **更新代码**
   ```bash
   # SSH 连接服务器
   cd /www/wwwroot/cosmos-explorer
   git pull origin main
   ```

2. **重新构建镜像**
   - 宝塔面板 → Docker → 镜像管理
   - 找到 `cosmos-explorer:latest`
   - 点击"重新构建"

3. **重启容器**
   - 容器管理 → 找到 `cosmos-explorer-app`
   - 点击"重启"

### 方法二：命令行快速更新

```bash
# 创建更新脚本
cat > /www/wwwroot/cosmos-explorer/update.sh << 'EOF'
#!/bin/bash
echo "🔄 开始更新应用..."

# 进入项目目录
cd /www/wwwroot/cosmos-explorer

# 拉取最新代码
git pull origin main

# 停止旧容器
docker stop cosmos-explorer-app
docker rm cosmos-explorer-app

# 重新构建镜像
docker build -t cosmos-explorer:latest .

# 启动新容器
docker run -d \
  --name cosmos-explorer-app \
  -p 80:80 \
  --restart unless-stopped \
  cosmos-explorer:latest

echo "✅ 更新完成！"
EOF

# 添加执行权限
chmod +x update.sh

# 执行更新
./update.sh
```

## 📊 宝塔面板 Docker 功能介绍

### 镜像管理
- **查看镜像**：列出所有 Docker 镜像
- **构建镜像**：从 Dockerfile 构建新镜像
- **删除镜像**：清理不需要的镜像
- **拉取镜像**：从 Docker Hub 拉取公共镜像

### 容器管理
- **创建容器**：从镜像创建新容器
- **启动/停止**：控制容器运行状态
- **查看日志**：实时查看容器日志
- **进入终端**：直接进入容器内部
- **资源监控**：查看 CPU、内存使用情况

### 网络管理
- **端口映射**：配置容器端口映射
- **网络模式**：选择容器网络模式
- **自定义网络**：创建 Docker 网络

## 🔧 常用操作

### 查看应用状态

1. **通过宝塔面板**
   - Docker → 容器管理
   - 查看 `cosmos-explorer-app` 状态

2. **通过命令行**
   ```bash
   # 查看容器状态
   docker ps | grep cosmos-explorer
   
   # 查看容器日志
   docker logs cosmos-explorer-app -f
   
   # 查看资源使用
   docker stats cosmos-explorer-app
   ```

### 故障排除

1. **容器无法启动**
   ```bash
   # 查看详细错误信息
   docker logs cosmos-explorer-app
   
   # 检查端口占用
   netstat -tlnp | grep :80
   
   # 重新构建镜像
   docker build -t cosmos-explorer:latest .
   ```

2. **应用无法访问**
   ```bash
   # 检查防火墙
   # 在宝塔面板 → 安全 → 防火墙
   # 确保 80 端口已开放
   
   # 检查容器端口映射
   docker port cosmos-explorer-app
   ```

### 备份和恢复

1. **备份镜像**
   ```bash
   # 导出镜像
   docker save cosmos-explorer:latest > cosmos-explorer-backup.tar
   
   # 压缩备份
   gzip cosmos-explorer-backup.tar
   ```

2. **恢复镜像**
   ```bash
   # 导入镜像
   docker load < cosmos-explorer-backup.tar.gz
   ```

## 🚀 自动化脚本

### 一键部署脚本

```bash
# 创建一键部署脚本
cat > /www/wwwroot/deploy-cosmos.sh << 'EOF'
#!/bin/bash

PROJECT_DIR="/www/wwwroot/cosmos-explorer"
CONTAINER_NAME="cosmos-explorer-app"
IMAGE_NAME="cosmos-explorer:latest"

echo "🚀 开始部署宇宙探索者..."

# 检查项目目录
if [ ! -d "$PROJECT_DIR" ]; then
    echo "📥 克隆项目..."
    cd /www/wwwroot
    git clone https://github.com/你的用户名/cosmos-explorer.git
fi

# 进入项目目录
cd $PROJECT_DIR

# 拉取最新代码
echo "📡 拉取最新代码..."
git pull origin main

# 停止并删除旧容器
echo "🛑 停止旧容器..."
docker stop $CONTAINER_NAME 2>/dev/null || true
docker rm $CONTAINER_NAME 2>/dev/null || true

# 构建新镜像
echo "🔨 构建 Docker 镜像..."
docker build -t $IMAGE_NAME .

# 启动新容器
echo "🚀 启动新容器..."
docker run -d \
  --name $CONTAINER_NAME \
  -p 80:80 \
  --restart unless-stopped \
  $IMAGE_NAME

# 检查容器状态
sleep 5
if docker ps | grep -q $CONTAINER_NAME; then
    echo "✅ 部署成功！"
    echo "🌍 访问地址: http://$(curl -s ifconfig.me)"
else
    echo "❌ 部署失败，请检查日志："
    docker logs $CONTAINER_NAME
fi
EOF

chmod +x /www/wwwroot/deploy-cosmos.sh
```

### 定时更新脚本

```bash
# 添加到定时任务
# 宝塔面板 → 计划任务 → 添加任务
# 任务类型：Shell脚本
# 执行周期：每天凌晨2点
# 脚本内容：
/www/wwwroot/deploy-cosmos.sh > /tmp/cosmos-deploy.log 2>&1
```

## 🎯 最佳实践

### 1. 目录结构建议

```
/www/wwwroot/
├── cosmos-explorer/          # 项目目录
│   ├── Dockerfile
│   ├── nginx.conf
│   └── src/
├── deploy-cosmos.sh          # 部署脚本
└── backups/                  # 备份目录
    └── cosmos-explorer-*.tar.gz
```

### 2. 安全配置

1. **防火墙设置**
   - 宝塔面板 → 安全 → 防火墙
   - 只开放必要端口：22 (SSH), 80 (HTTP), 443 (HTTPS), 8888 (宝塔)

2. **SSL 证书**
   - 宝塔面板 → 网站 → SSL
   - 申请免费 Let's Encrypt 证书

### 3. 监控告警

1. **宝塔监控**
   - 宝塔面板 → 监控
   - 设置 CPU、内存、磁盘告警

2. **容器监控**
   ```bash
   # 创建监控脚本
   cat > /www/wwwroot/monitor-cosmos.sh << 'EOF'
   #!/bin/bash
   
   if ! docker ps | grep -q cosmos-explorer-app; then
       echo "容器异常，尝试重启..."
       /www/wwwroot/deploy-cosmos.sh
   fi
   EOF
   
   # 添加到定时任务（每5分钟检查一次）
   ```

## 📞 总结

使用宝塔面板 + Docker 的部署方案具有以下优势：

1. **简单易用**：图形界面操作，降低技术门槛
2. **成本低廉**：无需额外的镜像仓库费用
3. **功能完整**：支持容器的完整生命周期管理
4. **集成度高**：与宝塔面板其他功能无缝集成

这个方案特别适合：
- 个人开发者
- 小型团队
- 对成本敏感的项目
- 不熟悉复杂 CI/CD 流程的用户

你觉得这个基于宝塔面板的部署方案如何？需要我详细说明某个步骤吗？
