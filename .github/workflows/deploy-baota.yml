name: éƒ¨ç½²åˆ°å®å¡”æœåŠ¡å™¨

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_NAME: cosmos-explorer
  CONTAINER_NAME: cosmos-explorer-app

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: é…ç½®å›½å†…é•œåƒæº
        run: |
          npm config set registry https://registry.npmmirror.com
          pnpm config set registry https://registry.npmmirror.com

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile
        
      - name: ç±»å‹æ£€æŸ¥
        run: pnpm type-check
        
      - name: ä»£ç æ£€æŸ¥
        run: pnpm lint
        
      - name: è¿è¡Œæµ‹è¯•
        run: pnpm test
        
      - name: æ„å»ºæ£€æŸ¥
        run: pnpm build

  # éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
  deploy-dev:
    needs: quality-check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment: development
    
    steps:
      - name: éƒ¨ç½²åˆ°å¼€å‘æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USERNAME }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ..."
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /www/wwwroot/${{ env.PROJECT_NAME }} || {
              echo "ğŸ“¥ é¦–æ¬¡éƒ¨ç½²ï¼Œå…‹éš†é¡¹ç›®..."
              cd /www/wwwroot
              git clone ${{ github.server_url }}/${{ github.repository }}.git ${{ env.PROJECT_NAME }}
              cd ${{ env.PROJECT_NAME }}
            }
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¡ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin
            git reset --hard origin/develop
            
            # åœæ­¢æ—§å®¹å™¨
            echo "ğŸ›‘ åœæ­¢æ—§å®¹å™¨..."
            docker stop ${{ env.CONTAINER_NAME }}-dev 2>/dev/null || true
            docker rm ${{ env.CONTAINER_NAME }}-dev 2>/dev/null || true
            
            # æ„å»ºæ–°é•œåƒ
            echo "ğŸ”¨ æ„å»º Docker é•œåƒ..."
            docker build -t ${{ env.PROJECT_NAME }}:dev .
            
            # å¯åŠ¨æ–°å®¹å™¨
            echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨..."
            docker run -d \
              --name ${{ env.CONTAINER_NAME }}-dev \
              -p 3000:80 \
              --restart unless-stopped \
              ${{ env.PROJECT_NAME }}:dev
            
            # å¥åº·æ£€æŸ¥
            echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
            sleep 10
            if curl -f http://localhost:3000/health; then
              echo "âœ… å¼€å‘ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
            else
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
              docker logs ${{ env.CONTAINER_NAME }}-dev --tail 20
              exit 1
            fi

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-prod:
    needs: quality-check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
      - name: éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /www/wwwroot/${{ env.PROJECT_NAME }} || {
              echo "ğŸ“¥ é¦–æ¬¡éƒ¨ç½²ï¼Œå…‹éš†é¡¹ç›®..."
              cd /www/wwwroot
              git clone ${{ github.server_url }}/${{ github.repository }}.git ${{ env.PROJECT_NAME }}
              cd ${{ env.PROJECT_NAME }}
            }
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¡ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin
            git reset --hard origin/main
            
            # å¤‡ä»½å½“å‰é•œåƒ
            echo "ğŸ’¾ å¤‡ä»½å½“å‰é•œåƒ..."
            docker tag ${{ env.PROJECT_NAME }}:latest ${{ env.PROJECT_NAME }}:backup-$(date +%Y%m%d-%H%M%S) 2>/dev/null || true
            
            # æ„å»ºæ–°é•œåƒ
            echo "ğŸ”¨ æ„å»º Docker é•œåƒ..."
            docker build -t ${{ env.PROJECT_NAME }}:latest .
            
            # åœæ­¢æ—§å®¹å™¨
            echo "ğŸ›‘ åœæ­¢æ—§å®¹å™¨..."
            docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
            docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true
            
            # å¯åŠ¨æ–°å®¹å™¨
            echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨..."
            docker run -d \
              --name ${{ env.CONTAINER_NAME }} \
              -p 80:80 \
              --restart unless-stopped \
              ${{ env.PROJECT_NAME }}:latest
            
            # å¥åº·æ£€æŸ¥
            echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
            sleep 15
            max_attempts=5
            attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              if curl -f http://localhost/health; then
                echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
                
                # æ¸…ç†æ—§é•œåƒï¼ˆä¿ç•™æœ€è¿‘3ä¸ªå¤‡ä»½ï¼‰
                echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
                docker images ${{ env.PROJECT_NAME }} --format "table {{.Repository}}:{{.Tag}}\t{{.CreatedAt}}" | \
                grep backup | sort -k2 -r | tail -n +4 | awk '{print $1}' | xargs -r docker rmi
                
                exit 0
              fi
              
              echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå°è¯• $attempt/$max_attempts..."
              sleep 10
              ((attempt++))
            done
            
            # å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå›æ»š
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."
            docker stop ${{ env.CONTAINER_NAME }}
            docker rm ${{ env.CONTAINER_NAME }}
            
            # æŸ¥æ‰¾æœ€æ–°çš„å¤‡ä»½é•œåƒ
            backup_image=$(docker images ${{ env.PROJECT_NAME }} --format "{{.Repository}}:{{.Tag}}" | grep backup | head -1)
            if [ ! -z "$backup_image" ]; then
              echo "ğŸ”„ å›æ»šåˆ°: $backup_image"
              docker tag $backup_image ${{ env.PROJECT_NAME }}:latest
              docker run -d \
                --name ${{ env.CONTAINER_NAME }} \
                -p 80:80 \
                --restart unless-stopped \
                ${{ env.PROJECT_NAME }}:latest
              echo "âœ… å›æ»šå®Œæˆ"
            else
              echo "âŒ æ²¡æœ‰æ‰¾åˆ°å¤‡ä»½é•œåƒ"
            fi
            
            exit 1

      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: "ğŸš€ å®‡å®™æ¢ç´¢è€…å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          
      - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: "âŒ å®‡å®™æ¢ç´¢è€…éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
